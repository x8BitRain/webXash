var p=Object.defineProperty;var w=(s,n,e)=>n in s?p(s,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[n]=e;var o=(s,n,e)=>w(s,typeof n!="symbol"?n+"":n,e);import{Xash3D as f,Net as u}from"./index-BmxlnV6X.js";class g extends f{constructor(e){super(e);o(this,"channel");o(this,"resolve");o(this,"ws");o(this,"peer");o(this,"multiplayerIP");this.multiplayerIP=e==null?void 0:e.multiplayerIP,this.net=new u(this)}async init(){await Promise.all([super.init(),this.connect()])}initConnection(e){var r;if(this.peer)return;this.peer=new RTCPeerConnection,this.peer.onicecandidate=t=>{t.candidate&&this.ws.send(JSON.stringify({event:"candidate",data:t.candidate.toJSON()}))},(r=e==null?void 0:e.getTracks())==null||r.forEach(t=>{this.peer.addTrack(t,e)});let d=0;this.peer.ondatachannel=t=>{t.channel.label==="write"&&(t.channel.onmessage=i=>{const c={ip:[127,0,0,1],port:8080,data:i.data};i.data.arrayBuffer?i.data.arrayBuffer().then(a=>{c.data=a,this.net.incoming.enqueue(c)}):this.net.incoming.enqueue(c)}),t.channel.onopen=()=>{if(d+=1,t.channel.label==="read"&&(this.channel=t.channel),d===2&&this.resolve){const i=this.resolve;this.resolve=void 0,i()}}}}async connect(){const e=await navigator.mediaDevices.getUserMedia({audio:!0});return new Promise(d=>{var i;this.resolve=d;let r;try{r=`ws://${this.multiplayerIP}/websocket`,this.ws=new WebSocket(r)}catch{alert(`Failed to connect to ${r}`),window.location.reload()}const t=async c=>{this.initConnection(e);const a=JSON.parse(c.data);if(a.event==="offer"){const h=typeof a.data=="string"?JSON.parse(a.data):a.data;await this.peer.setRemoteDescription(h);const l=await this.peer.createAnswer();await this.peer.setLocalDescription(l),this.ws.send(JSON.stringify({event:"answer",data:l}))}if(a.event==="candidate"){const h=typeof a.data=="string"?JSON.parse(a.data):a.data;await this.peer.addIceCandidate(h)}};(i=this.ws)==null||i.addEventListener("message",t)})}sendto(e){this.channel&&this.channel.send(e.data)}}export{g as Xash3DWebRTC};
