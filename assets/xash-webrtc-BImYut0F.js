var f=Object.defineProperty;var p=(d,r,e)=>r in d?f(d,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[r]=e;var c=(d,r,e)=>p(d,typeof r!="symbol"?r+"":r,e);import{Xash3D as w,Net as u}from"./index-c3_R-ArA.js";class v extends w{constructor(e){super(e);c(this,"channel");c(this,"resolve");c(this,"ws");c(this,"peer");c(this,"multiplayerIP");c(this,"onError");this.multiplayerIP=e==null?void 0:e.multiplayerIP,this.net=new u(this),this.onError=e==null?void 0:e.onError}async init(){await Promise.all([super.init(),this.connect()])}initConnection(e){var a;if(this.peer)return;this.peer=new RTCPeerConnection,this.peer.onicecandidate=t=>{t.candidate&&this.ws.send(JSON.stringify({event:"candidate",data:t.candidate.toJSON()}))},(a=e==null?void 0:e.getTracks())==null||a.forEach(t=>{this.peer.addTrack(t,e)});let s=0;this.peer.ondatachannel=t=>{t.channel.label==="write"&&(t.channel.onmessage=i=>{const o={ip:[127,0,0,1],port:8080,data:i.data};i.data.arrayBuffer?i.data.arrayBuffer().then(n=>{o.data=n,this.net.incoming.enqueue(o)}):this.net.incoming.enqueue(o)}),t.channel.onopen=()=>{if(s+=1,t.channel.label==="read"&&(this.channel=t.channel),s===2&&this.resolve){const i=this.resolve;this.resolve=void 0,i()}}}}_onError(e,s){var t;const a=e.target;a&&a.readyState&&a.readyState===3&&(confirm(`Failed to connect to ${s}, continue?`)||((t=this.onError)==null||t.call(this),window.location.reload()))}async connect(){const e=await navigator.mediaDevices.getUserMedia({audio:!0});return new Promise(s=>{var i;this.resolve=s;const a=`ws://${this.multiplayerIP}/websocket`;this.ws=new WebSocket(a),this.ws.onerror=o=>{this._onError(o,a),s(void 0)};const t=async o=>{this.initConnection(e);const n=JSON.parse(o.data);if(n.event==="offer"){const h=typeof n.data=="string"?JSON.parse(n.data):n.data;await this.peer.setRemoteDescription(h);const l=await this.peer.createAnswer();await this.peer.setLocalDescription(l),this.ws.send(JSON.stringify({event:"answer",data:l}))}if(n.event==="candidate"){const h=typeof n.data=="string"?JSON.parse(n.data):n.data;await this.peer.addIceCandidate(h)}};(i=this.ws)==null||i.addEventListener("message",t)})}sendto(e){this.channel&&this.channel.send(e.data)}}export{v as Xash3DWebRTC};
